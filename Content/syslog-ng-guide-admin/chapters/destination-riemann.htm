<?xml version="1.0" encoding="UTF-8"?>

 %entities;]&gt;
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd"><body condition="ose" name="configuring-destinations-riemann" oldrole="section">
<h1 condition="ose" name="configuring-destinations-riemann" oldrole="section"><span class="Code" oldrole="parameter">riemann</span>: Monitoring your data with Riemann</h1>
<MadCap:keyword term="destination drivers:[&lt;span class=&quot;Code&quot; oldrole=&quot;parameter&quot;&gt;riemann()&lt;/span&gt;, ' driver']"></MadCap:keyword>
<p oldrole="para">The <span class="Code" oldrole="parameter">riemann()</span> driver sends your data (for example, metrics or events) to a <a href="http://riemann.io/">Riemann</a> monitoring system.</p>
<p oldrole="para">For the list of available parameters, see <xref linkend="reference-destination-riemann"></xref>.</p>

<h6 oldrole="formalpara">Declaration:</h6>
<p oldrole="para"></p>

<pre class="Code" oldrole="synopsis">riemann(
	server("&lt;riemann-server-address&gt;")
	port("&lt;riemann-server-port&gt;")
	metric("&lt;the-metric-or-data-to-send-to-riemann&gt;")
);</pre>
<example xml:id="example-using-riemann">
<title>Using the riemann() driver</title>
<p oldrole="para">The following destination sends the value of the SEQNUM macro (the number of messages sent to this destination) as a metric to the Riemann server.</p>
<pre class="Code" oldrole="synopsis">@version: <entity>techversion</entity>

source s_network {
	network(port(12345));
};

destination d_riemann {
	riemann(
		server("localhost")
		port(5555)
		ttl("300.5")
		metric(int("$SEQNUM"))
		description("syslog-ng riemann test")
		state("ok")
		attributes(x-ultimate-answer("$(+ $PID 42)")
				   key("MESSAGE", rekey(add-prefix("x-")) )
				   )
	);
};

log {
	source(s_network);
	destination(d_riemann);
	flags(flow-control);
};</pre>
</example>
<p oldrole="para">For a detailed use-case on using <entity>abbrev</entity> with the Riemann monitoring system, see the article <a href="https://devops.com/guide-modern-monitoring-alerting/">A How to Guide on Modern Monitoring and Alerting by Fabien Wernli</a>.</p>

<h2 name="reference-destination-riemann">riemann() destination options</h2>
<indexterm>
<primary>destination drivers</primary>
<secondary><span class="Code" oldrole="parameter">riemann()</span> driver</secondary>
</indexterm>
<p oldrole="para">The <span class="Code" oldrole="parameter">riemann()</span> driver sends metrics or events to a <a href="http://riemann.io/">Riemann</a> monitoring system.</p>
<p oldrole="para">The <span class="Code" oldrole="parameter">riemann()</span> destination has the following options:</p>
<simplesect version="5.0" xmlns="http://docbook.org/ns/docbook">
<title>attributes()</title>
<indexterm type="parameter">
<primary>attributes()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>parameter list of the <span class="Code" oldrole="parameter">value-pairs()</span> option</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The <span class="Code" oldrole="parameter">attributes()</span> option adds extra metadata to the Riemann event, that can be displayed on the Riemann dashboard. To specify the metadata to add, use the syntax of the <span class="Code" oldrole="parameter">value-pairs()</span> option. For details on using <span class="Code" oldrole="parameter">value-pairs()</span>, see <xref linkend="concepts-value-pairs"></xref>.</p>
</simplesect>
<simplesect>
<title>description()</title>
<indexterm type="parameter">
<primary>description()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>template, macro, or string</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The value to add as the description field of the Riemann event.</p>
</simplesect>
<simplesect>
<MadCap:snippetBlock src="../../shared/chunk/option-destination-diskbuffer.htm"></MadCap:snippetBlock>
</simplesect>
<simplesect xml:id="riemann-option-event-time">
<title>event-time()</title>
<indexterm type="parameter">
<primary>event-time()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>template, macro, or string</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry>${UNIXTIME}</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> Instead of the arrival time into Riemann, <entity>abbrev</entity> can also send its own timestamp value.</p>
<p oldrole="para">This can be useful if Riemann is inaccessible for a while, and the messages are collected in the disk buffer until Riemann is accessible again. In this case, it would be difficult to differentiate between messages based on the arrival time only, because this would mean that there would be hundreds of messages with the same arrival time. This issue can be solved by using this option.</p>
<p oldrole="para">The <span class="Code" oldrole="parameter">event-time()</span> option takes an optional parameter specifying whether the time format is in seconds or microseconds. For example:</p>
<pre class="Code" oldrole="synopsis">event-time("$(* $UNIXTIME 1000000)" microseconds)
event-time("12345678" microseconds)
event-time("12345678" seconds)
event-time("12345678")</pre>
<p oldrole="para">In case the parameter is omitted, <entity>abbrev</entity> defaults to the seconds version. In case the <span class="Code" oldrole="parameter">event-time()</span> option is omitted altogether, <entity>abbrev</entity> defaults to the seconds version with <span class="Code" oldrole="userinput">$UNIXTIME</span>.</p>
<p oldrole="para">Note that the time format parameter requires:</p>
<ul oldrole="itemizedlist">
<li oldrole="listitem">
<p oldrole="para">riemann-c-client 1.10.0 or newer</p>
<p oldrole="para">In older versions of riemann-c-client, the microseconds option is not available.</p>
<p oldrole="para">In case your distribution does not contain a recent enough version of riemann-c-client and you wish to use microseconds, install a new version from <a href="https://github.com/algernon/riemann-c-client"></a>.</p>
<p oldrole="para">If you installed the new version in a custom location (instead of the default one), make sure that you append the directory of the pkg-config file (<span class="Code" oldrole="filename">.pc</span> file) to the environment variable <span class="Code" oldrole="userinput">export PKG_CONFIG_PATH=...</span>.</p>
<p oldrole="para">After calling <b oldrole="command">configure</b>, you should see the following message in the case of successful installation:</p>
<pre class="Code" oldrole="synopsis">[...]
 Riemann destination (module): yes, microseconds: yes
[...]</pre>
</li>
<li oldrole="listitem">
<p oldrole="para">Riemann 2.13 or newer</p>
<p oldrole="para">Older versions of Riemann cannot handle microseconds. No error will be indicated, however, the time of the event will be set to the timestamp when the message arrived to Riemann.</p>
</li>
</ul>
<example>
<title>Example event-time() option</title>
<pre class="Code" oldrole="synopsis">destination d_riemann {
   riemann(
   server("127.0.0.1")
   port(5555)
   event-time("${UNIXTIME}")
   [...]
   );
};</pre>
</example>
</simplesect>
<simplesect xml:id="riemann-option-flush-lines">
<title>flush-lines()</title>
<indexterm type="parameter">
<primary>flush-lines()</primary>
<secondary>riemann</secondary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>number</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry>1</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The <entity>abbrev</entity> application can send the messages in a batch to the Riemann server. To send messages in batches, increase the <span class="Code" oldrole="parameter">flush-lines()</span> parameter (by default, it is set to 1). The <entity>abbrev</entity> application waits for this number of lines to accumulate, and sends them off in a single batch. Increasing this number increases throughput as more messages are sent in a single batch, but also increases message latency. Note that currently the <span class="Code" oldrole="parameter">riemann()</span> destination does not have a timeout for sending messages if the batch is not full.</p>
<p oldrole="para">For example, if you set <span class="Code" oldrole="parameter">flush-lines()</span> to 100, <entity>abbrev</entity> waits for 100 messages. If the source sends a few messages, but less than 100 messages, <entity>abbrev</entity> will not send the messages to the destination. If you stop or reload <entity>abbrev</entity> or in case of network sources, the connection with the client is closed, <entity>abbrev</entity> automatically sends the unsent messages to the destination.</p>
<p oldrole="para">If an error occurs while sending the messages to the server, <entity>abbrev</entity> will try to resend every message from the batch. If it does not succeed (you can set the number of retry attempts in the <span class="Code" oldrole="parameter">retries()</span> option), <entity>abbrev</entity> drops every message in the batch.</p>
</simplesect>
<simplesect xml:id="riemann-option-host">
<title>host()</title>
<indexterm type="parameter">
<primary>host()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>template, macro, or string</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry>${HOST}</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The value to add as the host field of the Riemann event.</p>
</simplesect>
<simplesect>
<MadCap:snippetBlock src="../../shared/chunk/option-destination-log-fifo-size.htm"></MadCap:snippetBlock>
</simplesect>
<simplesect>
<title>metric()</title>
<indexterm type="parameter">
<primary>metric()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>template, macro, or string</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The numeric value to add as the metric field of the Riemann event. If possible, include type-hinting as well, otherwise the Riemann server will interpret the value as a floating-point number. The following example specifies the SEQNUM macro as an integer.</p>
<pre class="Code" oldrole="synopsis">metric(int("$SEQNUM"))</pre>
</simplesect>
<simplesect xml:id="riemann-option-port">
<title>port()</title>
<indexterm type="parameter">
<primary>port()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>number</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry>5555</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The port number of the Riemann server.</p>
</simplesect>
<simplesect>
<MadCap:snippetBlock src="../../shared/chunk/option-destination-retries.htm"></MadCap:snippetBlock>
</simplesect>
<simplesect>
<title>server()</title>
<indexterm type="parameter">
<primary>server()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>hostname or IP address</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry>127.0.0.1</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The hostname or IP address of the Riemann server.</p>
</simplesect>
<simplesect>
<title>service()</title>
<indexterm type="parameter">
<primary>service()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>template, macro, or string</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry>${PROGRAM}</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The value to add as the service field of the Riemann event.</p>
</simplesect>
<simplesect>
<title>state()</title>
<indexterm type="parameter">
<primary>state()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>template, macro, or string</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The value to add as the state field of the Riemann event.</p>
</simplesect>
<simplesect>
<title>tags()</title>
<indexterm type="parameter">
<primary>tags()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>string list</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry>the tags already assigned to the message</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The list of tags to add as the tags field of the Riemann event. If not specified <entity>abbrev</entity> automatically adds the tags already assigned to the message. If you set the <span class="Code" oldrole="parameter">tags()</span> option, only the tags you specify will be added to the event.</p>
</simplesect>
<simplesect>
<MadCap:snippetBlock src="../../shared/chunk/option-destination-throttle.htm"></MadCap:snippetBlock>
</simplesect>
<simplesect>
<title>timeout()</title>
<indexterm type="parameter">
<primary>timeout()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>number [seconds]</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The value (in seconds) to wait for an operation to complete, and attempt to reconnect the Riemann server if exceeded. By default, the timeout is disabled.</p>
</simplesect>
<simplesect>
<title>ttl()</title>
<indexterm type="parameter">
<primary>ttl()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>template, macro, or number</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry></entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The value (in seconds) to add as the ttl (time-to-live) field of the Riemann event.</p>
</simplesect>
<simplesect>
<title>type()</title>
<indexterm type="parameter">
<primary>type()</primary>
</indexterm>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colnum="1" colwidth="40pt"></colspec>
<tbody>
<row>
<entry>Type: 
                                 </entry>
<entry>tcp | tls | udp</entry>
</row>
<row>
<entry>Default: 
                                 </entry>
<entry>tcp</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The type of the network connection to the Riemann server: TCP, TLS, or UDP. For TLS connections, set the <span class="Code" oldrole="parameter">ca-file()</span> option to authenticate the Riemann server, and the <span class="Code" oldrole="parameter">cert-file()</span> and <span class="Code" oldrole="parameter">key-file()</span> options if the Riemann server requires authentication from its clients.</p>

<h6 oldrole="formalpara">Declaration 1:</h6>
<p oldrole="para"></p>

<pre class="Code" oldrole="synopsis">destination d_riemann {
	riemann(
		server("127.0.0.1")
		port(5672)
		type(
		   "tls"
		   ca-file("ca")
		   cert-file("cert") 
		   key-file("key")
		)
	);
};</pre>
<p oldrole="para">An alternative way to specify TLS options is to group them into a <span class="Code" oldrole="parameter">tls()</span> block. This allows you to separate them and ensure better readability.</p>

<h6 oldrole="formalpara">Declaration 2:</h6>
<p oldrole="para"></p>

<pre class="Code" oldrole="synopsis">destination d_riemann {
	riemann(
		server("127.0.0.1")
		port(5672)
		type("tls")<i oldrole="emphasis" role="bold">
		tls(
			ca-file("ca")
			cert-file("cert") 
			key-file("key")
		)</i>
	);
};</pre>
<p oldrole="para">Make sure that you specify TLS options either using <span class="Code" oldrole="parameter">type()</span> or using the <span class="Code" oldrole="parameter">tls()</span> block. Avoid mixing the two methods. In case you do specify TLS options in both ways, the one that comes later in the configuration file will take effect.</p>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colname="c1" colnum="1" colwidth="40pt"></colspec>
<colspec colname="c2" colnum="2"></colspec>
<tbody>
<row>
<entry>
<indexterm type="parameter">
<primary>cacert()</primary>
</indexterm>
<indexterm type="parameter">
<primary>ca-file()</primary>
</indexterm><i oldrole="emphasis" role="bold">ca-file()</i>
</entry>
<entry></entry>
</row>
<row>
<entry>Type: 
                                 </entry>
<entry>path to a CA certificate in PEM format</entry>
</row>
<row>
<entry>Default:
                                 </entry>
<entry></entry>
</row>
<row>
<entry nameend="c2" namest="c1">
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> Path to the CA certificate in PEM format that signed the certificate of the Riemann server. When establishing TLS connection, <entity>abbrev</entity> verifies the certificate of the Riemann server using this CA.</p>
<p oldrole="para"><i oldrole="emphasis" role="bold">Alternative 1:</i></p>
<pre class="Code" oldrole="synopsis">type(
	"tls"
	<i oldrole="emphasis" role="bold">ca-file("/opt/syslog-ng/etc/syslog-ng/riemann-cacert.pem")</i>
	)</pre>
<p oldrole="para"><i oldrole="emphasis" role="bold">Alternative 2:</i></p>
<pre class="Code" oldrole="synopsis">riemann(
	.
	.
	type("tls")
<i oldrole="emphasis" role="bold">	tls(
          	ca-file("/opt/syslog-ng/etc/syslog-ng/riemann-cacert.pem")
	)</i></pre>
<p condition="ose" oldrole="para">This option was called <span class="Code" oldrole="parameter">cacert()</span> up until (and including) <entity>abbrev</entity> version 3.12.</p>
</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colname="c1" colnum="1" colwidth="40pt"></colspec>
<colspec colname="c2" colnum="2"></colspec>
<tbody>
<row>
<entry>
<indexterm type="parameter">
<primary>cert()</primary>
</indexterm>
<indexterm type="parameter">
<primary>cert-file()</primary>
</indexterm><i oldrole="emphasis" role="bold">cert-file()</i>
</entry>
<entry></entry>
</row>
<row>
<entry>Type: 
                                 </entry>
<entry>path to a certificate in PEM format</entry>
</row>
<row>
<entry>Default:
                                 </entry>
<entry></entry>
</row>
<row>
<entry nameend="c2" namest="c1">
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> Path to the a certificate file in PEM format. When establishing TLS connection, <entity>abbrev</entity> authenticates on the Riemann server using this certificate and the matching private key set in the <span class="Code" oldrole="parameter">key-file()</span> option.</p>
<MadCap:snippetBlock src="../../shared/chunk/destination-riemann-tls-description.htm"></MadCap:snippetBlock>
<p condition="ose" oldrole="para">This option was called <span class="Code" oldrole="parameter">cert()</span> in <entity>abbrev</entity> version 3.7.</p>
</entry>
</row>
</tbody>
</tgroup>
</informaltable>
<informaltable colsep="0" frame="topbot" rowsep="0">
<tgroup cols="2">
<colspec colname="c1" colnum="1" colwidth="40pt"></colspec>
<colspec colname="c2" colnum="2"></colspec>
<tbody>
<row>
<entry>
<indexterm type="parameter">
<primary>key()</primary>
</indexterm>
<indexterm type="parameter">
<primary>key-file()</primary>
</indexterm><i oldrole="emphasis" role="bold">key-file()</i>
</entry>
<entry></entry>
</row>
<row>
<entry>Type: 
                                 </entry>
<entry>path to a private key file</entry>
</row>
<row>
<entry>Default:
                                 </entry>
<entry></entry>
</row>
<row>
<entry nameend="c2" namest="c1">
<p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> Path to the private key of the certificate file set in the <span class="Code" oldrole="parameter">cert-file()</span> option. When establishing TLS connection, <entity>abbrev</entity> authenticates on the Riemann server using this private key and the matching certificate set in the <span class="Code" oldrole="parameter">cert-file()</span> option.</p>
<MadCap:snippetBlock src="../../shared/chunk/destination-riemann-tls-description.htm"></MadCap:snippetBlock>
<p condition="ose" oldrole="para">This option was called <span class="Code" oldrole="parameter">key()</span> in <entity>abbrev</entity> version 3.7.</p>
</entry>
</row>
</tbody>
</tgroup>
</informaltable>
</simplesect>

</body></html>
